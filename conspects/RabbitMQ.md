[Гарантии NoSQL](#гарантии-nosql-)\
[Цепочка ответственности](#цепочка-ответственности-)\
[Принцип работы RabbitMQ](#принцип-работы-rabbitmq-)\
[Exchange](#exchange-)\
[Queue](#queue)\
[Binding](#binding)\
[AMQP канал](#amqp-канал)\

###### Гарантии NoSQL:
    At-most-once delivery - сообщение доставлено 1 раз или не доставлено ни разу
    At-least-once delivery - сообщение доставлено минимум 1 раз или больше
    Exactly-once delivery - сообщение гарантировано доставлено 1 раз

    RabbitMQ и Kafka имеют FIFO гарантии. RabbitMQ гарантирует FIFO на уровне queue, Kafka на уровне topic partition.
Если во время процесса доставки сообщения consumer сдох, мы хотим чтобы сообщение было получено другим консюмером.
Нам интересно как минимум At-least-once delivery.\
Никто кроме Kafka не может гарантировать Exctly-once delivery, мы можем строить нашу логику таким образом, 
что повторное получение сообщения не окажет вреда, однако не все операции могут быть идемпотентны.
---

###### Цепочка ответственности:
    Продюссер не может знать что его ообщения используются. Для этого есть концепция цепочки ответственности, 
    которая начинается с издателя, затем переходит к системе обмена сообщениями и далее к потребителю. 
    Каждый должен вести себя правильно, когда наступает его очередь нести ответственность за сообщение.

###### Принцип работы RabbitMQ:
	- Издатель отправляет сообщение определенному обменнику (Exchange)
	- Обменник маршрутизирует его в одну или несколько очередей
	- Очередь хранит ссылку на это сообщение. Само сообщение хранится в памяти или на диске
	- Как потребитель готов получить сообщение, сервер создает и отправляет копию сообщения
	- Потребитель получает сообщение и отправляет брокеру подтверждение
	- Брокер удаляет копию сообщения из очереди. Затем удаляет из оперативной памяти и с диска
---

###### Exchange:
    - exchange точка обмена куда publisher отправляет сообщения.
    - exchange маршрутизирует сообщения на основе созданных связей (bindings) между ним и очередью.
    - exchange это строка (ссылка на модуль, где лежит логика маршрутизации) во встроенной бд.
######
    Direct exchange - доставляет сообщение в определенные очереди. Сообщение публикуется в exchange с ключом маршрутизации
    и попадает во все очереди, которые связаны с этим обменником аналогичным ключом маршрутизации. 
    ключ маршрутизации - это строка. Поиск соответствия происходит при помощи проверки строк на эквивалентность.
######
    Topic exchange - дает возможность выборочной маршрутизации путем сравнения ключа маршрутизации. 
    Но, в данном случае, ключ задается по шаблону. При создании шаблона используются 0+ слов (AZaz, 0-9, *,#)
         - шаблоны в **exchange** предсталяют собой структуру tree.
         - шаблоны * быстрее #
         - topic **exchange** медленнее direct exchange
######
    Fanout exchange - все сообщения доставляются во все очереди даже если в сообщении задан ключ маршрутизации.
         - fanout exchange самы быстры из всех
         - все консюмеры при fanout exchange должны уметь обрабатывать все сообщения.
######
    Headers exchange - направляет сообщения на основе сравнения пар (key, val) свойства headers привязки и аналогичного 
    свойства сообщения. headers представляет собой Dictionary<key, val>
         - если добавить специальный ключ "x-match": "any", сообщение маршрутизируется при частичном совпадении key val.
           Поведение аналогично оператору or.
         - по умолчанию ключ "x-match": "all" , сообщение маршрутизируется при частичном совпадении key val.
           Поведение аналогично оператору and.
######
    Поведение обменников можно комбинировать при помощи связи Exchange-to-Exchange.
    Создание обменника происходит при помощи синхронного RPC запроса к серверу с параметрами:
        - название exchange
        - тип exchange
        - и другие
    Обменник должен быть создан перед публикацией сообщений иначе сообщение будет удалено.
---

###### Queue
    Queue - структура данных на диске или в оперативной памяти, 
    которая хранит ссылки на сообщения и отдает их копии потребителям.
- **autoDelete** - флаг. очередь удаляет себя когда все клиенты отсоединились.
- **exclusive** - флаг. разрешает подключаться только одному потребителю и удаляется если закроется канал.
- **durable** - флаг. очередь сохраняет состояние и восстанавливается после перезапуска брокера
---

###### Binding 
    Binding - правило, которое сообщает обменнику в какую из очередей должны попадать сообщения.
---

###### AMQP канал
    AMQP канал - это механизм позволящий мультиплексировать несколько логических потоков поверх одного соединения, 
    что в свою очередь позволяет лучше использовать ресурсы.
- клиент может создавать 1+ каналов для связи с брокером, для того чтобы отправлять команды.
- команды в рамках одного канала гарантировано выполняются в последовательности отправки.
- жизненный цикл комманды привязан к соединению. если соединение закрыто, каналы вместе с ним.
---